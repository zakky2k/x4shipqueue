# Canonical Ware Production Model (CWPM)

This document defines the Canonical Ware Production Model (CWPM), the single
authoritative representation of production data derived from X4: Foundations
game files.

CWPM is generated by tools/build_ware_catalogue.py and is the only approved
source of ware production data for all downstream consumers.

This document is normative.

---

## 1. Purpose

The CWPM exists to:

- Provide a lossless, canonical representation of all ware production data
- Merge base game and extension production consistently
- Eliminate duplicated XML parsing logic
- Separate discovery from consumption
- Enable deterministic, testable downstream calculations

Once CWPM has been built, no downstream component may read wares.xml directly.

CWPM (facts)
   ↓
Method Resolution (policy)
   ↓
Material Aggregation (math)
---

## 2. Top-level structure

The CWPM is a single JSON object keyed by ware_id.

  {
    "<ware_id>": { ... },
    "<ware_id>": { ... }
  }

### Invariants

- ware_id is unique across the entire catalogue
- All lookups are ware-centric, not transport-centric
- CWPM is deterministic (same inputs → same output)
- No XML access is required once CWPM has been built

---

## 3. CWPM entry schema (per ware)

Each ware entry may contain three sections:

  {
    "<transport>": { ... },
    "price": { ... },              // optional
    "productionMethods": { ... }   // always present (may be empty)
  }

---

## 4. Transport block (required, exactly one)

Each ware must contain exactly one transport block, keyed by the transport name
as defined in wares.xml.

Observed transport values include (not exhaustive):

- ship
- equipment
- container
- inventory
- liquid
- solid
- other

### Transport block schema

  "<transport>": {
    "name": "{page,id}",
    "description": "{page,id}",
    "group": "string | null",
    "volume": int,
    "tags": [ "string", ... ],

    // optional, transport-specific
    "component": "macro_id",
    "licence": "string",
    "owners": [ "faction", ... ]
  }

### Rules

- Transport is implicit via the key name
- No "transport": "ship" duplication exists anywhere
- Transport-specific metadata lives only inside this block
- Unknown or unused fields are allowed and ignored downstream

---

## 5. Price block (optional)

Present only when a <price> element exists in XML.

  "price": {
    "min": int,
    "average": int,
    "max": int
  }

### Rules

- Prices are informational only
- Prices do not affect production calculations
- Missing price data is valid (e.g. research wares)

---

## 6. productionMethods block (required)

This block is always present, but may be empty.

  "productionMethods": {
    "<method>": { ... },
    "<method>": { ... }
  }

### Method keys

Method names are preserved exactly as defined in XML, including:

- default
- terran
- teladi
- closedloop
- xenon
- additional methods introduced by DLC or mods

No renaming or normalisation is performed.

---

## 7. Production method schema

  "<method>": {
    "time": int,
    "amount": int,
    "name": "{page,id}",
    "resources": {
      "<ware_id>": int,
      "<ware_id>": int
    },

    // optional
    "tags": [ "string", ... ]
  }

### Rules

- resources keys are ware IDs
- Resource amounts are always integers
- No resource translation occurs at this level
- tags may include:
  - noplayerbuild
  - other method-specific flags

---

## 8. Buildable vs non-buildable wares

CWPM explicitly distinguishes existence from buildability.

### Buildable ware

  "productionMethods": {
    "default": { ... }
  }

### Non-buildable ware (research, unlocks, etc.)

  "productionMethods": {}

### Rules

- Empty productionMethods is valid
- Filtering happens in schemas and calculators
- CWPM retains all wares for completeness and future extensibility

---

## 9. Injected production (DLC / extensions)

Injected production (via <add><production>) is merged, not flattened.
### Overlay semantics

Injected production via `<add>` elements:
- always targets an existing ware
- never creates new wares
- may introduce new production methods
- must not modify existing method definitions

CWPM builders must fail if an injected production references an unknown ware_id.

Example:

  "productionMethods": {
    "default": { ... },
    "terran": { ... },
    "closedloop": { ... }
  }

### Rules

- Injected methods must not overwrite existing methods
- Method collisions raise errors during catalogue build
- Source file location is irrelevant once merged into CWPM

---

## 10. CWPM Consumer Rules (Normative)

All consumers of CWPM must comply with the following rules.

### 10.1 Source of truth

- CWPM is the only approved source for:
  - production resources
  - production times
  - production methods
- Consumers must not parse wares.xml directly

---

### 10.2 Buildability

- A ware is buildable only if productionMethods is non-empty
- Consumers must explicitly filter non-buildable wares
- Consumers must not assume:
  - transport == ship implies buildable
  - presence of a component implies buildable

---

### 10.3 Resource handling

- Resource keys must be treated as opaque ware IDs
- Translation and localisation occur only at display or export time
- Resource quantities must be treated as integers

---

### 10.4 Method selection

- Consumers must explicitly select a production method
- No implicit fallback between methods is allowed
- default is not guaranteed to exist for all wares

---

### 10.5 Extension safety

- Consumers must assume new production methods may appear
- Unknown methods must not cause failures
- Filtering of methods (e.g. excluding xenon) is a consumer responsibility

---

## 11. Relationship to other documents

- PIPELINE.md defines execution stages and responsibility boundaries
- DATA_CONTRACT.md defines structural and semantic guarantees
- CWPM.md defines the canonical production model itself

These documents together form the architectural contract of the project.

---

## 12. Canonical statement

If production data is not present in CWPM, it is not canonical.

Any deviation from this model must be explicitly documented and justified.
